# llama-swappo-halo with STT: LLM + Whisper for AMD Strix Halo
#
# Requires whisper-stt-rocm image to be built first:
#   (cd /path/to/krohnos-k3s/applications/ai/whisper-stt && ./build.sh)
#
# Build: buildah bud -f Containerfile.stt -t llama-swappo-halo:stt .

ARG BACKEND=rocm-6.4.4-rocwmma
ARG WHISPER_IMAGE=whisper-stt-rocm:latest

# Build llama-swappo
FROM alpine:latest AS builder

RUN apk add --no-cache git go nodejs npm ca-certificates

WORKDIR /build
RUN git clone https://github.com/mootikins/llama-swappo.git && \
    cd llama-swappo/ui && npm install && npm run build && \
    cd .. && CGO_ENABLED=0 go build -o llama-swap . && strip llama-swap

# Whisper binaries from pre-built image
FROM ${WHISPER_IMAGE} AS whisper

# Runtime
FROM kyuz0/amd-strix-halo-toolboxes:${BACKEND}

WORKDIR /app
RUN mkdir -p /models /models/stt /app/lib

# Copy llama-swappo
COPY --from=builder /build/llama-swappo/llama-swap /app/llama-swap

# Copy whisper binaries and libs
COPY --from=whisper /app/whisper-server /app/whisper-server
COPY --from=whisper /app/whisper-cli /app/whisper-cli
COPY --from=whisper /app/lib/ /app/lib/

RUN chmod +x /app/llama-swap /app/whisper-server /app/whisper-cli && \
    dnf install -y ffmpeg-free && dnf clean all

ENV LD_LIBRARY_PATH=/app/lib:/opt/rocm/lib:$LD_LIBRARY_PATH
ENV PATH="/app:${PATH}"

HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
    CMD curl -f http://localhost:8080/health || exit 1

EXPOSE 8080
ENTRYPOINT ["/app/llama-swap"]
